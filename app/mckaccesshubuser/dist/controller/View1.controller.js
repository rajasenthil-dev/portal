sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/m/WizardStep"],(e,t,r,o,s)=>{"use strict";var a={prevUserSelect:null};return e.extend("mckaccesshubuser.controller.View1",{onInit:function(){this._wizard=this.byId("wizard");this._oNavContainer=this.byId("wizardNavContainer");this._oWizardContentPage=this.byId("wizardContentPage");var e=jQuery.sap.getModulePath("mckaccesshubuser.model","/manufacturerGroupMap.json");var r=new sap.ui.model.json.JSONModel;var o=[{manufacturerNumber:"0001000024",groupId:"00gkmbbie9xNhlxcb1d7",groupName:"MFG_Reports_All"},{manufacturerNumber:"0001000011",groupId:"00gkmbbie9xNhlxcb1d7",groupName:"MFG_Reports_All"},{manufacturerNumber:"0001000025",groupId:"00gkmb9nd4VgJ9b8v1d7",groupName:"MFG_Reports_NoBKO_NoFinance"},{manufacturerNumber:"0001000011",groupId:"00gkmbbie9xNhlxcb1d7",groupName:"MFG_Reports_All"},{manufacturerNumber:"0001000018",groupId:"00gkmbc4l40FFT6m51d7",groupName:"MFG_Reports_NoFinance_NoInvoiceHistory"},{manufacturerNumber:"0001000015",groupId:"00gkmbc4l40FFT6m51d7",groupName:"MFG_Reports_NoFinance_NoInvoiceHistory"},{manufacturerNumber:"0001000016",groupId:"00gkmbc4l40FFT6m51d7",groupName:"MFG_Reports_NoFinance_NoInvoiceHistory"}];r.setData({mappings:o});this.getView().setModel(r,"groupMapping");this.model=new t;this.model.setProperty("/selectedUser","InternalUser");this.model.setData({selectedUser:"InternalUser",editGroup:false,groupAction:0,selectedGroup:"",selectedGroupName:"",firstName:"",lastName:"",email:"",manufacturerNumber:"",MFGName:"",profitCentre:"",salesOrg:"",salesOffice:"",newGroupName:"",groupDetails:{groupList:[]},internalChecklist:[{title:"Create a ServiceNow Request",description:"Use the 'AD Group Membership' request type."},{title:"Enter User's Info",description:"Name, email, and whether they are a new hire or transfer."},{title:"Select Correct AD Group",description:"BTP_INTERNAL_USERS for NAMCK or MFG_INTERNAL_USERS_CA for CA."},{title:"Write a Clear Business Justification",description:"Why this access is needed."},{title:"Approval Path",description:"Manager → Application Owner → AD Group Admin"}],approvalSteps:[{step:"Manager Approval",icon:"sap-icon://employee-approvals"},{step:"Application Owner Approval",icon:"sap-icon://user-settings"},{step:"AD Group Admin Adds User",icon:"sap-icon://shield"}]});this.getView().setModel(this.model,"userContext");const s=this.getView().getModel("userContext").getProperty("/selectedGroup");console.log("Selected Group:",s);const a=this.byId("internalInstructions");const i=this.byId("internalInstructions1");const n=this.byId("externalUserInfo");const l=this.byId("mfgUserInfo");const u=this.byId("groupUserInfo");a.setHtmlText(`\n            <p>This request ensures your user gets the right access securely and on time.</p>\n  \n            <ul>\n              <li><strong>New Hire or Transfer?</strong> Pick carefully for correct approvals.</li>\n              <li><strong>Domain:</strong> NAMCK (North America) or CA (Canada).</li>\n              <li><strong>AD Group:</strong> BTP_INTERNAL_USERS (NA) or MFG_INTERNAL_USERS_CA (CA).</li>\n              <li><strong>Business Justification:</strong> Keep it clear to avoid delays.</li>\n            </ul>\n    \n          `);i.setHtmlText(`\n              <ol>\n                <li>Manager reviews</li>\n                <li>Application Owner approves</li>\n                <li>AD Group Admin adds the user</li>\n              </ol>\n              <p class="tipText"><strong>Tip: </strong>More Info = <em>Faster Approvals</em></p>\n            `);n.setHtmlText(`\n              <p>Please enter accurate details for the external user. These will be <strong>provisioned to Okta</strong> and may affect downstream systems.</p>\n              <ul>\n                <li><strong>Names</strong> should be spelled exactly as per official documentation.</li>\n                <li><strong>Email</strong> must be a valid, active partner address.</li>\n              </ul>\n              <p class="tipText"><strong>Tip:</strong> Double-check the email for typos. Approval and access links go here!</p>\n            `);l.setHtmlText(`\n              <p>Please enter accurate <strong>manufacturer details</strong>. These are used to filter the user’s data access in the system.</p>\n              <ul>\n                <li>Manufacturer Number & Name must match internal records exactly.</li>\n                <li>Profit Center, Sales Org, and Sales Office affect data visibility and reporting.</li>\n              </ul>\n              <p class="tipText"><strong>Tip:</strong> These values will be validated via backend filters and CDS authorizations, so accuracy is crucial.</p>\n            `);u.setHtmlText(`\n              <p><strong>User groups</strong> define what applications and data the user can access in the Build Work Zone.</p>\n              <ul>\n                <li>Prefer existing groups to keep things clean and consistent.</li>\n                <li>If creating a new group, choose a clear, descriptive name.</li>\n                <li>Groups are managed centrally and tied to application roles.</li>\n              </ul>\n              <p class="tipText"><strong>Tip:</strong> Reach out to your admin team before creating a new group — there may already be one that fits your need!</p>`);let p=this.getView().getModel("userContext");p.setProperty("/editUserDetails",false);p.setProperty("/editManufacturerDetails",false);p.setProperty("/editGroup",false)},_loadOktaGroups:function(){var e=this.getView();var t=e.getModel("userContext");var r=e.getModel("oktaService");var o=e.getModel("groupMapping");if(!t||!o){console.error("Required models not found. Did you set them in onInit?");sap.m.MessageBox.error("Missing models required to fetch Okta groups.");return}var s=r.bindContext("/getOktaGroups(...)");s.setParameter("query","MFG");s.execute().then(function(){var e=s.getBoundContext().getObject();var r=e?.value||[];console.log(">>> Debug: selectedGroup before anything:",t.getProperty("/selectedGroup"));console.log(">>> Debug: selectedGroupName before anything:",t.getProperty("/selectedGroupName"));console.log(">>> Debug: groupAction:",t.getProperty("/groupAction"));console.log(">>> Debug: isInitialized:",t.getProperty("/isInitialized"));console.log(">>> Debug: groups count:",r.length);console.log(">>> Debug: groups ids:",r.map(e=>e.id));console.log(">>> Debug: groups names:",r.map(e=>e.profile?.name||e.name));console.log("Fetched Groups (count):",r.length);console.log("Fetched Groups IDs:",r.map(e=>e.id));console.log("Fetched Groups names:",r.map(e=>e.profile?.name||e.name));t.setProperty("/groupDetails/groupList",r);var a=String(t.getProperty("/selectedGroup")||"");var i=!!t.getProperty("/isInitialized");var n=r.some(e=>String(e.id)===a);if(n){console.log("Existing selectedGroup is valid:",a);var l=r.find(e=>String(e.id)===a);t.setProperty("/selectedGroupName",l.profile?.name||l.name||"")}else{var u=t.getProperty("/manufacturerNumber");var p=null;if(u){var c=o.getProperty("/mappings")||[];var d=c.find(e=>e.manufacturerNumber===u);if(d){p=r.find(e=>String(e.id)===d.groupId);if(p){console.log("Auto-mapped group found:",p);t.setProperty("/selectedGroup",String(p.id));t.setProperty("/selectedGroupName",p.profile?.name||p.name||"");t.setProperty("/isGroupMapped",true)}else{console.warn("Mapping exists but group id not in fetched groups",d.groupId)}}else{console.log("No mapping found for manufacturer:",u)}}if(!p&&!a&&!i&&r.length>0){var g=r[0];t.setProperty("/selectedGroup",String(g.id));t.setProperty("/selectedGroupName",g.profile?.name||g.name||"");console.log("Defaulted to first group on initial load:",g)}else if(!p&&a){console.warn("Current selection not found in fetched groups but preserving it:",a)}}t.setProperty("/isInitialized",true);t.updateBindings(true)}).catch(function(e){console.error("Error fetching groups:",e);sap.m.MessageBox.error("Failed to fetch Okta groups.")})},onGroupChange:function(e){var t=e.getParameter("selectedItem").getKey();var r=e.getParameter("selectedItem").getText();var o=this.getView().getModel("userContext");o.setProperty("/selectedGroup",t);o.setProperty("/selectedGroupName",r);console.log("User selected new group:",t,r)},goToUserStep:function(){debugger;var e=this.model.getProperty("/selectedUser");switch(e){case"ExternalUser":this.byId("UserTypeStep").setNextStep(this.getView().byId("stepExternalDetails"));break;case"InternalUser":default:this.byId("UserTypeStep").setNextStep(this.getView().byId("stepInternalFinal"));break}},goToGroupStep:function(){this._loadOktaGroups()},setUserMethod:function(){this.setDiscardableProperty({message:"Are you sure you want to change the user type? This will discard your progress.",discardStep:this.byId("UserTypeStep"),modelPath:"/selectedUser",historyPath:"prevUserSelect"})},setDiscardableProperty:function(e){const t=this.model.getProperty(e.modelPath);if(this._wizard.getProgressStep()!==e.discardStep){o.warning(e.message,{actions:[o.Action.YES,o.Action.NO],onClose:function(r){if(r===o.Action.YES){this._wizard.discardProgress(e.discardStep);a[e.historyPath]=t;this.goToUserStep()}else{this.model.setProperty(e.modelPath,a[e.historyPath])}}.bind(this)})}else{a[e.historyPath]=t;this.goToUserStep()}},onWizardReview:function(){debugger;const e=this.getView().getModel("userContext");if(!e){sap.m.MessageToast.show("User context model is missing!");return}const t=e.getProperty("/selectedUser");if(t==="InternalUser"){this._oNavContainer.to(this.byId("internalReviewPage"))}else{let e=this.getView().getModel("userContext");e.setProperty("/editUserDetails",false);e.setProperty("/editManufacturerDetails",false);e.setProperty("/editGroup",false);this._oNavContainer.to(this.byId("externalReviewPage"))}},onFinishInternal:function(){this._oNavContainer.to(this.byId("finishPage"))},onStartOver:function(){var e=this.byId("wizard");this.setUserMethod();this.getView().getModel("userContext").setData({});this.byId("userMethodSelection").setSelectedKey("InternalUser");this._oNavContainer.to(this.byId("wizardContentPage"))},onExitWizard:function(){window.top.location.href="/"},onCreateOktaGroup:function(){debugger;var e=this.getView();var t=e.getModel("oktaService");var r=e.getModel("userContext");var o={name:r.getProperty("/newGroupName"),description:"Custom group for MFG user"};var s=t.bindContext("/createOktaGroup(...)");s.setParameter("group",{profile:o});s.execute().then(function(){var e=s.getBoundContext().getObject();r.setProperty("/selectedGroup",e.id);r.setProperty("/selectedGroupName",e.profile?.name||e.name);var t=r.getProperty("/groupDetails/groupList")||[];t.push(e);r.setProperty("/groupDetails/groupList",t);sap.m.MessageToast.show("Group created and selected.")}).catch(function(e){console.error("Failed to create group:",e);sap.m.MessageBox.error("Could not create new Okta group.")})},onSubmitOktaUser:function(){var e=this.getView();var t=e.getModel("userContext").getData();var r={user:{profile:{firstName:t.firstName,lastName:t.lastName,email:t.email,login:t.email,salesOffice:t.salesOffice,profitCentre:t.profitCentre,salesOrg:t.salesOrg,manufacturerNumber:[t.manufacturerNumber],mfgName:t.MFGName},groupIds:[t.selectedGroup]}};var o=this.getView().getModel("oktaService");var s=o.bindContext("/createOktaUser(...)");s.setParameter("user",r.user);var a=this;s.execute().then(function(){var e=s.getBoundContext().getObject();sap.m.MessageBox.success(`User created successfully!\nID: ${e.userId}`,{title:"Success",onClose:function(){var e=a.byId("navContainer");e.to(a.byId("finishPage"))}})}).catch(function(e){console.error("Error creating Okta user:",e);sap.m.MessageBox.error("Failed to create user in Okta.")})},onToggleEditUserDetails:function(){let e=this.getView().getModel("userContext");let t=e.getProperty("/editUserDetails");e.setProperty("/editUserDetails",!t)},onToggleEditManufacturerDetails:function(){let e=this.getView().getModel("userContext");let t=e.getProperty("/editManufacturerDetails");e.setProperty("/editManufacturerDetails",!t)},onToggleEditGroup:function(){let e=this.getView().getModel("userContext");let t=e.getProperty("/editGroup");e.setProperty("/editGroup",!t)},_initModel:function(){this.model=new t({externalUserDetails:{firstName:"",lastName:"",email:"",company:"",oktaProvisioning:true},manufacturerDetails:{manufacturerNumber:"",manufacturerName:"",profitCenter:"",salesOrg:"",salesOffice:""},groupDetails:{isNewGroup:false,groupList:["MFG_Reports_Internal","MFG_Reports_All","MFG_Reports_NoPricing","MFG_Reports_NoCashJournal","MFG_Reports_NoInvoiceHistory","MFG_Reports_NoBackOrder","MFG_Reports_NoBKO_NoFinance","MFG_Reports_NoFinance_NoInvoiceHistory","MFG_Reports_NoFinance_NoInvoiceHistory_NoBKO","MFG_Reports_NoAllocation","MFG_Reports_NoPatientId","MFG_Admin","MFG_Cards_NoSalesBy","MFG_Reports_NoFinance","MFG_Reports_All_PivotTable","MFG_Reports_NoFinance_NoInvoiceHistory_NoReturn_NoShipping_RC","MFG_Reports_NoCashJournal_NoReturn_NoShipping","MFG_Reports_BuySell"],selectedGroup:""}});this.getView().setModel(this.model,"userContext")},onAfterRendering:function(){const e=this.byId("manufacturerNumber");const t=this.byId("manufacturerHelp");e.addEventDelegate({onfocusin:()=>{t.setVisible(true);t.addStyleClass("helperMessage--visible")},onfocusout:()=>{let r=e.getValue();if(r&&r.length<10){r=r.padStart(10,"0");e.setValue(r)}if(r.length===10&&/^\d{10}$/.test(r)){e.setValueState("None");e.setValueStateText("")}t.removeStyleClass("helperMessage--visible");t.addStyleClass("helperMessage--hide");setTimeout(()=>{t.setVisible(false);t.removeStyleClass("helperMessage--hide")},250)}})},onManufacturerNumberChange:function(e){const t=e.getSource();let r=t.getValue();r=r.replace(/\D/g,"");if(r.length>10){t.setValueState("Error");t.setValueStateText("Cannot exceed 10 digits.")}else if(r.length<10){t.setValueState("Error");t.setValueStateText("Must be exactly 10 digits.")}else{t.setValueState("None")}if(r.length>10){r=r.substring(0,10)}t.setValue(r)}})});
//# sourceMappingURL=View1.controller.js.map