sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast"],function(e,t,n,o){"use strict";return e.extend("pivottable.controller.View1",{onInit:function(){const e={JANUARY:1,FEBRUARY:2,MARCH:3,APRIL:4,MAY:5,JUNE:6,JULY:7,AUGUST:8,SEPTEMBER:9,OCTOBER:10,NOVEMBER:11,DECEMBER:12};const t=new sap.ui.model.json.JSONModel({monthTotals:{JANUARY:0,FEBRUARY:0,MARCH:0,APRIL:0,MAY:0,JUNE:0,JULY:0,AUGUST:0,SEPTEMBER:0,OCTOBER:0,NOVEMBER:0,DECEMBER:0}});this.getView().setModel(t,"tileModel");this._sSelectedKey="Ladega";const n=this.byId("table0");const o=this.byId("bar0");const s=this.byId("idIconTabBar");this._oSmartTable=n;n.attachInitialise(()=>{this._bTableReady=true;if(s){s.setSelectedKey("Ladega")}const e=n.getTable();if(e){e.attachRowsUpdated(this._onRowsUpdated.bind(this))}});o.attachEventOnce("initialized",()=>{this._bFilterReady=true;const e=(new Date).getFullYear().toString();const t=o.getControlByKey("CAL_YEAR");if(t&&t.setSelectedKey){t.setSelectedKey([e])}o.fireFilterChange();o.search()});n.attachBeforeRebindTable(this._onBeforeRebindTable,this)},_applyInitialSort:function(){var e=this.byId("table");var t=e.getBinding("items");if(!t)return;t.sort([new sap.ui.model.Sorter("PROVINCE_REGIO",false),new sap.ui.model.Sorter("SHIP_TO_NAME",false)])},_onTabSelect:function(e){debugger;const t=e.getParameter("key");this._sSelectedKey=t;this._oSmartTable.rebindTable()},_attemptInitialRebind:function(){if(this._bSmartTableReady&&this._bFilterBarReady){this._oSmartTable.rebindTable()}},_onRowsUpdated:function(){const e=this.byId("table0");const t=e.getTable();const n=t.getBinding("rows");if(!n)return;const o=n.getContexts(0,n.getLength());if(!o.length)return;const s=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];const a={};s.forEach(e=>a[e]=0);let i=0;let l=o.length;o.forEach(e=>{const t=e.getObject();s.forEach(e=>{const n=Number(t[e]||0);a[e]+=n;i+=n})});let r={month:"",value:0};s.forEach(e=>{if(a[e]>r.value){r={month:e,value:a[e]}}});const c=l>0?i/l:0;this.byId("FooterText1").setText(i.toLocaleString());this._renderMonthlyTiles(a);this._renderAdvancedTiles({ytd:i,highest:r,avg:c,rows:l});this._generateMonthBadges(a)},_refreshUserModel:async function(){const e=this.getOwnerComponent().getModel("userModel");var t=sap.ui.require.toUrl("pivottable").split("/resources")[0];if(t==="."){t=""}const n=t+"/user-api/attributes";try{const t=await fetch(n);const o=await t.json();e.setData(o);console.log("✅ User model refreshed:",o)}catch(e){console.error("❌ Failed to fetch user info",e)}},_fetchAndSetLogo:function(){const e=this.getView();const t=this.getOwnerComponent().getModel("userModel");const n=t?t.getData():{};const o=n.ManufacturerNumber;const s=e.byId("logoImage");var a=sap.ui.require.toUrl("pivottable").split("/resources")[0];if(a==="."){a=""}const i=a+"/images/MCKCAN1.jpg";if(!o){console.warn("No ManufacturerNumber in user model. Showing fallback logo.");s.setSrc(i);return}const l=this.getOwnerComponent().getModel("logo");const r=new sap.ui.model.Filter("manufacturerNumber","EQ",o);const c=l.bindList("/MediaFile",undefined,undefined,[r]);c.requestContexts().then(function(e){if(e&&e.length>0){const t=e[0].getObject();const n=t.url.replace(/^.*(?=\/odata\/v4\/media)/,"");const o=a+n;s.setSrc(o)}else{console.warn("No matching logo found. Fallback image used.");s.setSrc(i)}}.bind(this)).catch(function(e){console.error("Binding error:",e);s.setSrc(i)}.bind(this))},_onPatternMatched:async function(){await this._refreshUserModel();console.log("RouteView1 pattern matched – fetching logo...");this._fetchAndSetLogo()},_onSmartTableInit:function(){this._oTable=this._oSmartTable.getTable()},onFilterSelect:function(e){this._sSelectedKey=e.getParameter("key");this._oSmartTable.rebindTable()},_onBeforeRebindTable:function(e){const t=e.getParameter("bindingParams");const n=[];t.sorter=[new sap.ui.model.Sorter("PROVINCE_REGIO",false),new sap.ui.model.Sorter("SHIP_TO_NAME",false)];switch(this._sSelectedKey){case"Ladega":n.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"LEDAGA"));break;case"SIGNIFOR":n.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"SIGNIFOR"));break;case"Cystadrops":n.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"CYSTADROPS"));break}t.filters.push.apply(t.filters,n)},formatOrDash:function(e){if(e==="00000000"||!e){return"--"}else{return e?e:"--"}},_calculateMonthlyTotals:function(){const e=this.byId("table0");const t=e.getTable();const n=t.getBinding("rows");if(!n)return;const o=n.getContexts();if(!o.length)return;const s=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];const a={};s.forEach(e=>a[e]=0);o.forEach(e=>{const t=e.getObject();s.forEach(e=>{a[e]+=Number(t[e]||0)})});this._renderMonthlyTiles(a)},_renderMonthlyTiles:function(e){const t=this.byId("monthlyTileContainer");t.removeAllItems();const n=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];n.forEach(n=>{const o=e[n]||0;const s=new sap.m.VBox({alignItems:"Center",justifyContent:"Center",items:[new sap.m.Label({text:n.substring(0,3),design:"Bold"}).addStyleClass("mckMonthTileHeader"),new sap.m.Text({text:o.toLocaleString()}).addStyleClass("mckMonthTileValue")]}).addStyleClass("mckMonthTile");t.addItem(s)})},_renderAdvancedTiles:function(e){const t=this.byId("advancedTileContainer");t.removeAllItems();const n=[{title:"YTD Total",value:e.ytd,icon:"sap-icon://sum",color:"blue"},{title:"Highest Month",value:e.highest.value,subtitle:e.highest.month,icon:"sap-icon://arrow-top",color:"orange"},{title:"Average / Month",value:e.avg,icon:"sap-icon://measure",color:"grey"},{title:"Total Customers",value:e.rows,icon:"sap-icon://list",color:"green"}];n.forEach(e=>{const n=new sap.m.VBox({width:"180px",height:"90px",alignItems:"Start",justifyContent:"Center",items:[new sap.m.HBox({alignItems:"Center",items:[new sap.ui.core.Icon({src:e.icon,size:"1.5rem"}).addStyleClass("advTileIcon"),new sap.m.Label({text:e.title,design:"Bold"}).addStyleClass("advTileTitle")]}),new sap.m.Text({text:e.value.toLocaleString()}).addStyleClass("advTileValue"),e.subtitle?new sap.m.Text({text:e.subtitle}).addStyleClass("advTileSubtitle"):new sap.m.Text({text:""})]}).addStyleClass("advTile advTile-"+e.color);t.addItem(n)})},_generateMonthBadges:function(e){const t=this.byId("monthBadgesBox");t.removeAllItems();const n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];const o={JANUARY:1,FEBRUARY:2,MARCH:3,APRIL:4,MAY:5,JUNE:6,JULY:7,AUGUST:8,SEPTEMBER:9,OCTOBER:10,NOVEMBER:11,DECEMBER:12};Object.keys(e).forEach(s=>{const a=e[s];let i=Number(s);if(isNaN(i)){i=o[s.toUpperCase()]||null}if(!i){console.warn("Invalid month key:",s);return}const l=n[i-1];const r=new sap.m.HBox({items:[new sap.m.Text({text:l}).addStyleClass("mckMonthName"),new sap.m.Text({text:a.toLocaleString()}).addStyleClass("mckMonthValue")]}).addStyleClass("mckMonthChip");t.addItem(r)})}})});
//# sourceMappingURL=View1.controller.js.map