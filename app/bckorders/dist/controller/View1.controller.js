sap.ui.define(["sap/ui/core/mvc/Controller","bckorders/model/formatter","sap/m/MessageBox"],(t,e,o)=>{"use strict";var i="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer";return t.extend("bckorders.controller.View1",{formatter:e,onInit:function(){const t=this.getOwnerComponent().getRouter();t.getRoute("RouteView1").attachPatternMatched(this._onPatternMatched,this);var e=this.getOwnerComponent().getModel();const i=this.getView();const s=i.byId("smartFilterBar");i.setBusy(true);s.attachInitialized(function(){i.setBusy(false)});const n=this.getView().byId("table0");const r=n.getTable();this.bAuthorizationErrorShown=false;e.attachRequestFailed(function(t){var e=t.getParameters();if(e.response.statusCode==="403"){r.setNoData("No data available due to authorization restrictions");r.setBusy(false);if(!this.bAuthorizationErrorShown){this.bAuthorizationErrorShown=true;o.error("You do not have the required permissions to access this report.",{title:"Unauthorized Access",id:"messageBoxId1",details:"Permission is required to access this report. Please contact your administrator if you believe this is an error or require access.",contentWidth:"100px"})}}});r.attachEvent("rowsUpdated",this._calculateTotals.bind(this))},_refreshUserModel:async function(){const t=this.getOwnerComponent().getModel("userModel");var e=sap.ui.require.toUrl("bckorders").split("/resources")[0];if(e==="."){e=""}const o=e+"/user-api/attributes";try{const e=await fetch(o);const i=await e.json();t.setData(i);console.log("✅ User model refreshed:",i)}catch(t){console.error("❌ Failed to fetch user info",t)}},_fetchAndSetLogo:function(){const t=this.getView();const e=this.getOwnerComponent().getModel("userModel");const o=e?e.getData():{};const i=o.ManufacturerNumber;const s=t.byId("logoImage");var n=sap.ui.require.toUrl("bckorders").split("/resources")[0];if(n==="."){n=""}const r=n+"/images/MCKCAN1.jpg";if(!i){console.warn("No ManufacturerNumber in user model. Showing fallback logo.");s.setSrc(r);return}const a=this.getOwnerComponent().getModel("logo");const c=new sap.ui.model.Filter("manufacturerNumber","EQ",i);const l=a.bindList("/MediaFile",undefined,undefined,[c]);l.requestContexts().then(function(t){if(t&&t.length>0){const e=t[0].getObject();const o=e.url.replace(/^.*(?=\/odata\/v4\/media)/,"");const i=n+o;s.setSrc(i)}else{console.warn("No matching logo found. Fallback image used.");s.setSrc(r)}}.bind(this)).catch(function(t){console.error("Binding error:",t);s.setSrc(r)}.bind(this))},_onPatternMatched:async function(){await this._refreshUserModel();console.log("RouteView1 pattern matched – fetching logo...");this._fetchAndSetLogo()},_calculateTotals:function(){const t=this.getView().byId("table0");const e=t.getTable();const o=e.getBinding("rows");if(!o){console.warn("Table binding is missing.");this._updateTile("TileContent1","0");this._updateTile("TileContent2","0");this._updateTile("TileContent3","0");this._updateTile("TileContent4","0");this._updateTile("TileContent5","0");this._updateFooter("footerText1","0");this._updateFooter("footerText2","0");return}const i=o.getContexts(0,o.getLength());if(!i||i.length===0){console.warn("Data is not available for calculation.");this._updateTile("TileContent1","0");this._updateTile("TileContent2","0");this._updateTile("TileContent3","0");this._updateTile("TileContent4","0");this._updateTile("TileContent5","0");this._updateFooter("footerText1","0");this._updateFooter("footerText2","0");return}const s=i.reduce((t,e)=>{const o=e.getObject();if(!o)return t;if(o.VBELN){t.uniqueBackOrders.add(o.VBELN)}if(o.KUNRE_ANA){t.impactedCustomers.add(o.KUNRE_ANA)}if(o.MATNR){t.totalItemsOnBackOrder.add(o.MATNR)}t.totalUnitsBackOrdered+=parseFloat(o.BACK_ORD_QTY||0);t.totalExtension+=parseFloat(o.EXTENSION||0);if(o.DATE_DIFF>0&&!o.UDATE){t.totalUnitsToBeReceived+=parseFloat(o.BACK_ORD_QTY||0)}return t},{uniqueBackOrders:new Set,impactedCustomers:new Set,totalItemsOnBackOrder:new Set,totalUnitsBackOrdered:0,totalUnitsToBeReceived:0,totalExtension:0});const n=s.uniqueBackOrders.size;const r=s.impactedCustomers.size;const a=s.totalItemsOnBackOrder.size;const c=this.formatter?this.formatter.formatCurrency?this.formatter.formatCurrency(s.totalExtension,"USD"):s.totalExtension:s.totalExtension;const l=this.formatter?this.formatter.formatNumber?this.formatter.formatNumber(s.totalUnitsBackOrdered):s.totalUnitsBackOrdered:s.totalUnitsBackOrdered;this._updateTile("TileContent1",this.formatNumberWithCommas?this.formatNumberWithCommas(n):n);this._updateTile("TileContent2",this.formatNumberWithCommas?this.formatNumberWithCommas(r):r);this._updateTile("TileContent3",this.formatNumberWithCommas?this.formatNumberWithCommas(a):a);this._updateTile("TileContent4",this.formatNumberWithCommas?this.formatNumberWithCommas(s.totalUnitsBackOrdered):s.totalUnitsBackOrdered);this._updateTile("TileContent5",this.formatNumberWithCommas?this.formatNumberWithCommas(s.totalUnitsToBeReceived):s.totalUnitsToBeReceived);this._updateFooter("footerText1",l);this._updateFooter("footerText2",c)},_updateTile:function(t,e){const o=this.getView().byId(t);if(o&&o.getContent()){if(o.getContent().setText){o.getContent().setText(e)}else if(o.setText){o.setText(e)}}else{console.warn("Tile or Tile Content not found:",t)}},_updateFooter:function(t,e){const o=this.getView().byId(t);if(o&&o.setText){o.setText(e)}else{console.warn("Footer element not found:",t)}},formatNumberWithCommas:function(t){if(t===null||t===undefined){return""}return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},formatNumberWithCommas:function(t){if(!t||isNaN(t))return"0";return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},_updateTile:function(t,e){const o=this.byId(t);if(o){o.setText(e)}else{console.warn(`Tile with ID ${t} not found.`)}},_updateFooter:function(t,e){const o=this.byId(t);if(o){o.setText(e)}else{console.warn(`Footer with ID ${t} not found.`)}}})});
//# sourceMappingURL=View1.controller.js.map