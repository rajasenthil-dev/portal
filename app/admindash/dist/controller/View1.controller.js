sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/format/FileSizeFormat","sap/m/MessageBox"],function(e,t,r,i,a){"use strict";return e.extend("admindash.controller.View1",{onInit:function(){this.oUploadSet=this.byId("fileUploader");this._oModel=this.getOwnerComponent().getModel();this.getView().setModel(new r({fileData:null,csrfToken:null,manufacturerNumber:"",mfgName:"",existingManufacturers:[],existingMfgNames:[]}),"ui");this._binding=null;this.getView().getModel("ui").setProperty("/isEditMode",true);this._fetchExistingManufacturers()},onBeforeRendering:function(){this._fetchCSRFToken()},_fetchExistingManufacturers:function(){var e=sap.ui.require.toUrl("admindash").split("/resources")[0];if(e==="."){e=""}return fetch(e+"/odata/v4/media/MediaFile").then(e=>e.json()).then(e=>{var t=e.value.map(e=>e.manufacturerNumber);var r=e.value.map(e=>e.MFGName);this.getView().getModel("ui").setProperty("/existingManufacturers",t);this.getView().getModel("ui").setProperty("/existingMfgNames",r)}).catch(e=>console.error("Error fetching manufacturers:",e))},onChange:function(e){var t=e.getParameter("files")?.[0];var r=this.getView().getModel("ui");if(t){r.setProperty("/fileData",{file:t,fileName:t.name,fileSize:i.getInstance({binaryFilesize:false,maxFractionDigits:1,maxIntegerDigits:3}).format(t.size),fileType:t.type})}else{r.setProperty("/fileData",null)}},onOpenDialog:function(){const e=this.getView().getModel("ui");e.setProperty("/isEditMode",false);this.getView().byId("addManufacturerDialog").open()},onEditPress:function(){const e=this.byId("idMediaFilesTable");const t=e.getSelectedItems();if(t.length!==1){a.warning("Please select exactly one file to edit.");return}const r=t[0].getBindingContext();const i=r.getObject();const n=this.getView().getModel("ui");n.setProperty("/isEditMode",true);n.setProperty("/manufacturerNumber",i.manufacturerNumber);n.setProperty("/mfgName",i.MFGName);n.setProperty("/fileData",{fileName:i.fileName,fileType:i.mediaType,fileUrl:i.url});this._editBindingContext=r;this.getView().byId("addManufacturerDialog").open()},onCloseDialog:function(){this.getView().byId("addManufacturerDialog").close()},onUploadPress:async function(){const e=!!this._editBindingContext;const t=this.getView().getModel("ui");const r=t.getProperty("/fileData/file");const i=t.getProperty("/manufacturerNumber");const n=t.getProperty("/mfgName");const o=t.getProperty("/csrfToken");const s=t.getProperty("/existingManufacturers").map(e=>e.toLowerCase());const l=t.getProperty("/existingMfgNames").map(e=>e.toLowerCase());const u=e?this._editBindingContext.getProperty("manufacturerNumber").toLowerCase():null;const c=e?this._editBindingContext.getProperty("MFGName").toLowerCase():null;if(s.includes(i.toLowerCase())&&(!e||i.toLowerCase()!==u)){a.error("This Manufacturer Number already exists.");return}if(l.includes(n.toLowerCase())&&(!e||n.toLowerCase()!==c)){a.error("This Manufacturer Name already exists.");return}if(!this._validateUploadInputs(i,n,r,e))return;try{if(!this._binding){if(e){this._binding=this.getView().getModel().bindContext(this._editBindingContext.getPath(),null,{$$updateGroupId:"UploadGroup"})}else{const e=await this._createDraft(i,n,r.name,r.type,o);if(e?.context){this._binding=this.getView().getModel().bindContext(e.context.getPath(),null,{$$updateGroupId:"UploadGroup"})}}}if(r){await this._updateDraftWithContent(this._binding.getPath(),r,r.type,r.name,o)}await this._activateDraft(this._binding.getPath(),o);a.success("File uploaded successfully.");this._editBindingContext=null;this._resetForm();this.onCloseDialog()}catch(e){a.error("Error during upload process: "+e.message)}},_fetchCSRFToken:function(){var e=sap.ui.require.toUrl("admindash").split("/resources")[0];if(e==="."){e=""}return fetch(e+"/odata/v4/media/",{method:"GET",headers:{"X-CSRF-Token":"Fetch"},credentials:"include"}).then(e=>{if(!e.ok)throw new Error("Failed to fetch CSRF token");this.getView().getModel("ui").setProperty("/csrfToken",e.headers.get("x-csrf-token"))}).catch(e=>console.error("Error fetching CSRF token: ",e))},_validateUploadInputs:function(e,t,r,i){if(!e)return a.error("Please enter a Manufacturer Number."),false;if(!t)return a.error("Please enter an MFG Name."),false;if(!r&&!i)return a.error("Please choose a file to upload."),false;return true},_resetForm:function(){var e=this.getView().getModel("ui");this.byId("fileUploader").clear();e.setProperty("/fileData",null);e.setProperty("/manufacturerNumber","");e.setProperty("/mfgName","");this.getView().getModel().refresh();this._binding=null;this.byId("idMediaFilesTable").removeSelections(true)},_createDraft:function(e,t,r,i,a){var n=sap.ui.require.toUrl("admindash").split("/resources")[0];if(n==="."){n=""}return fetch(n+"/odata/v4/media/MediaFile",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":a},credentials:"include",body:JSON.stringify({manufacturerNumber:e,MFGName:t,fileName:r,mediaType:i})}).then(e=>e.json()).then(e=>({context:{getPath:()=>`/MediaFile(ID=${e.ID},IsActiveEntity=false)`}})).catch(e=>{throw new Error("Failed to create draft: "+e.message)})},_updateDraftWithContent:async function(e,t,r,i,n){try{const a=await fetch(this._oModel.sServiceUrl+e+"/content",{method:"PUT",headers:{"X-CSRF-Token":n,"Content-Type":r,slug:i},credentials:"include",body:t});console.log("Server Response Status:",a.status);if(!a.ok){throw new Error(`Failed to upload file. Server responded with status: ${a.status}`)}let o=null;let s=null;if(a.status===204){console.warn("Server returned 204 No Content. Constructing file URL manually...")}else{const e=await a.text();console.log("Raw server response:",e);if(e){try{const t=JSON.parse(e);s=t?.ID}catch(e){console.warn("Response is not valid JSON.")}}}let l=e.replace("IsActiveEntity=false","IsActiveEntity=true");o=this._oModel.sServiceUrl+l+"/content";console.log("Final file URL:",o);this.getView().getModel("ui").setProperty("/fileData/fileUrl",o);const u=await fetch(this._oModel.sServiceUrl+e,{method:"PATCH",headers:{"X-CSRF-Token":n,"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({url:o})});if(!u.ok){throw new Error(`Failed to update file URL in backend. Status: ${u.status}`)}console.log("âœ… File URL successfully updated in backend.")}catch(e){console.error("Upload error:",e.message);a.error("Upload error: "+e.message)}},_activateDraft:function(e,t){debugger;var r=sap.ui.require.toUrl("admindash").split("/resources")[0];if(r==="."){r=""}return fetch(`${r}/odata/v4/media${e}/Media.draftActivate`,{method:"POST",headers:{"X-CSRF-Token":t,"Content-Type":"application/json"},credentials:"include"}).then(e=>{if(!e.ok)throw new Error("Failed to activate draft")}).catch(e=>{throw new Error("Error activating draft: "+e.message)})},onTypeMissmatch:function(){a.error("Invalid file type. Allowed types are: txt, pdf, docx, jpg, png, jpeg")},onManufacturerNumberLiveChange:function(e){var t=e.getParameter("value");var r=e.getSource();var i=this.getView().getModel("ui");var a=i.getProperty("/existingManufacturers");if(/[a-zA-Z]/.test(t)){r.setValueState("Error");r.setValueStateText("Manufacturer Number should not contain letters.")}else{r.setValueState("None")}if(a.includes(t)){r.setValueState("Error");r.setValueStateText("This Manufacturer Number already exists.")}else{r.setValueState("None")}},onManufacturerNameLiveChange:function(e){var t=e.getParameter("value");var r=e.getSource();var i=this.getView().getModel("ui");var a=i.getProperty("/existingMfgNames").map(e=>e.toLowerCase());if(a.includes(t)){r.setValueState("Error");r.setValueStateText("This Manufacturer Name already exists.")}else{r.setValueState("None")}},onDeleteDraft:function(){var e=this.byId("idMediaFilesTable");var t=e.getSelectedItems();if(!t.length){a.warning("Please select at least one draft to delete.");return}a.warning("Make sure ONLY entries you want to delete are selected. Once deleted, this action cannot be undone.",{actions:[a.Action.OK,a.Action.CANCEL],emphasizedAction:a.Action.OK,onClose:e=>{if(e===a.Action.OK){this._deleteDrafts(t)}}})},_deleteDrafts:function(e){var r=this.getView().getModel();var i=[];e.forEach(e=>{var t=e.getBindingContext();i.push(t.delete())});Promise.all(i).then(()=>{t.show("Selected items deleted successfully.");r.refresh()}).catch(e=>{a.error("Error deleting items: "+e.message)})}})});
//# sourceMappingURL=View1.controller.js.map