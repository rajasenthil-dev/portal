sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/m/Dialog","sap/m/Button","sap/m/Image","sap/m/MessageBox"],(e,t,o,n,r,i,a,s)=>{"use strict";return e.extend("openar.controller.View1",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteView1").attachPatternMatched(this._onPatternMatched,this);var t=this.getOwnerComponent().getModel();const o=this.getView();const n=o.byId("bar0");o.setBusy(true);if(n){n.attachInitialized(function(){o.setBusy(false)})}else{console.error("SmartFilterBar with ID 'bar0' not found.");o.setBusy(false)}debugger;const r=o.byId("table0");if(r){const e=r.getTable();if(e){this.bAuthorizationErrorShown=false;if(t){t.attachRequestFailed(t=>{var o=t.getParameters();if(o.response&&o.response.statusCode===403){e.setNoData("No data available due to authorization restrictions");e.setBusy(false);if(!this.bAuthorizationErrorShown){this.bAuthorizationErrorShown=true;s.error("You do not have the required permissions to access this report.",{title:"Unauthorized Access",id:"messageBoxId1",details:"Permission is required to access this report. Please contact your administrator if you believe this is an error or require access."})}}else{console.error("OData request failed:",o.response)}},this)}else{console.error("Main OData Model not found.")}e.attachEvent("rowsUpdated",this._calculateFooterAndSummary.bind(this))}else{console.error("Inner table within SmartTable 'table0' not found.");o.setBusy(false)}}else{console.error("SmartTable with ID 'table0' not found.");o.setBusy(false)}},_refreshUserModel:async function(){const e=this.getOwnerComponent().getModel("userModel");var t=sap.ui.require.toUrl("openar").split("/resources")[0];if(t==="."){t=""}const o=t+"/user-api/attributes";try{const t=await fetch(o);const n=await t.json();e.setData(n);console.log("✅ User model refreshed:",n)}catch(e){console.error("❌ Failed to fetch user info",e)}},_fetchAndSetLogo:function(){const e=this.getView();const t=this.getOwnerComponent().getModel("userModel");const o=t?t.getData():{};const n=o.ManufacturerNumber;const r=e.byId("logoImage");var i=sap.ui.require.toUrl("openar").split("/resources")[0];if(i==="."){i=""}const a=i+"/images/MCKCAN1.jpg";if(!n){console.warn("No ManufacturerNumber in user model. Showing fallback logo.");r.setSrc(a);return}const s=this.getOwnerComponent().getModel("logo");const c=new sap.ui.model.Filter("manufacturerNumber","EQ",n);const u=s.bindList("/MediaFile",undefined,undefined,[c]);u.requestContexts().then(function(e){if(e&&e.length>0){const t=e[0].getObject();const o=t.url.replace(/^.*(?=\/odata\/v4\/media)/,"");const n=i+o;r.setSrc(n)}else{console.warn("No matching logo found. Fallback image used.");r.setSrc(a)}}.bind(this)).catch(function(e){console.error("Binding error:",e);r.setSrc(a)}.bind(this))},_onPatternMatched:async function(){await this._refreshUserModel();console.log("RouteView1 pattern matched – fetching logo...");this._fetchAndSetLogo()},_calculateFooterAndSummary:function(){var e=this.byId("table0");if(!e){console.error("SmartTable 'table0' not found in _calculateFooterAndSummary.");return}var o=e.getTable();if(!o){console.error("Inner table not found in _calculateFooterAndSummary.");return}var n=o.getBinding("rows");if(!n||!n.getLength()){console.warn("Table binding 'rows' not ready or has zero length in _calculateFooterAndSummary.");return}var r=n.getContexts(0,n.getLength());if(!r||r.length===0){console.log("No contexts available in _calculateFooterAndSummary.");return}var i={fTotCurrent:0,fTot1to30:0,fTot31to60:0,fTot61to90:0,fTotOver90:0,fTotInvoice:0,fTotAmountPaid:0};r.forEach(function(e){i.fTotCurrent+=this._getValueOrZero(e,"CAL_CURRENT");i.fTot1to30+=this._getValueOrZero(e,"CAL_1_30");i.fTot31to60+=this._getValueOrZero(e,"CAL_31_60");i.fTot61to90+=this._getValueOrZero(e,"CAL_61_90");i.fTotOver90+=this._getValueOrZero(e,"CAL_OVER_90");i.fTotInvoice+=this._getValueOrZero(e,"NETWR_VBRK");i.fTotAmountPaid+=this._getValueOrZero(e,"TSL_CLEARED")},this);Object.keys(i).forEach(function(e){var t=this._getFooterIndex(e);if(t>0){var o=this.byId("footerText"+t);if(o){var n=this._formatCurrency(i[e]);o.setText(n)}else{console.warn("Footer text element 'footerText"+t+"' not found for key: "+e)}}},this);var a=this.getOwnerComponent().getModel("i18n").getResourceBundle();var s=[{BucketName:a.getText("OPENAR.CURRENTGRAPH"),Amount:i.fTotCurrent},{BucketName:a.getText("OPENAR.1_to_30"),Amount:i.fTot1to30},{BucketName:a.getText("OPENAR.31_to_60"),Amount:i.fTot31to60},{BucketName:a.getText("OPENAR.61_to_90"),Amount:i.fTot61to90},{BucketName:a.getText("OPENAR.OVER_90"),Amount:i.fTotOver90}];var c=this.getView().getModel("pieChartModel");if(!c){c=new t;this.getView().setModel(c,"pieChartModel")}c.setData({agingData:s});this._updatePastDue(r);this._updateBalanceOwed(i.fTotInvoice,i.fTotAmountPaid);this._updateOpenInvoices(r);this._updateAvgAge(o)},_getValueOrZero:function(e,t){var o=e.getProperty(t);return o!==null&&o!==undefined?parseFloat(o):0},_formatCurrency:function(e){if(e==null){return""}try{const t=o.getCurrencyInstance({currencyCode:false,groupingEnabled:true,showMeasure:false});return isNaN(e)?"":t.format(e)}catch(t){console.error("Error formatting currency:",t);return String(e)}},_getFooterIndex:function(e){var t={fTotCurrent:1,fTot1to30:2,fTot31to60:3,fTot61to90:4,fTotOver90:5,fTotInvoice:6,fTotAmountPaid:7};return t[e]||0},_updatePastDue:function(e){var t=0;var o=new Date;o.setHours(0,0,0,0);e.forEach(e=>{var n=e.getObject();if(n&&n.NETDT){var r=this._parseDate(n.NETDT);var i=(n.NETWR_VBRK||0)-(n.TSL_CLEARED||0);if(r&&r<o&&i>0){t+=i}}},this);var n=this._formatAmount(t);var r=this.byId("_IDGenNumericContent2");if(r)r.setText(n)},_updateBalanceOwed:function(e,t){var o=(e||0)-(t||0);var n=this._formatAmount(o);var r=this.byId("_IDGenNumericContent1");if(r)r.setText(n)},_updateOpenInvoices:function(e){var t=e.filter(e=>{var t=e.getObject();if(t){var o=(t.NETWR_VBRK||0)-(t.TSL_CLEARED||0);return o>0}return false}).length;var o=this.byId("_IDGenNumericContent5");if(o)o.setText(t)},_updateAvgAge:function(e){if(!e)return;var t=e.getBinding("rows");if(!t||!t.getLength())return;var o=t.getContexts(0,t.getLength());if(!o||o.length===0)return;var n=o.filter(e=>{var t=e.getObject();return t&&(t.NETWR_VBRK||0)-(t.TSL_CLEARED||0)>0});if(n.length===0){var r=this.byId("_IDGenNumericContent4");if(r)r.setText("0.0");return}var i=n.reduce((e,t)=>{var o=t.getObject();return e+(o&&o.CAL_AGE?parseFloat(o.CAL_AGE):0)},0);var a=i/n.length;var r=this.byId("_IDGenNumericContent4");if(r)r.setText(a.toFixed(1))},_formatAmount:function(e){if(e==null)return"$0.00";e=parseFloat(e);if(isNaN(e))return"$0.00";if(Math.abs(e)>=1e6)return"$"+(e/1e6).toFixed(1)+"M";if(Math.abs(e)>=1e3)return"$"+(e/1e3).toFixed(1)+"K";return"$"+e.toFixed(2)},_parseDate:function(e){if(!e)return null;let t=null;if(typeof e==="string"&&e.length===8&&/^\d{8}$/.test(e)){const o=e.substring(0,4);const n=e.substring(4,6);const r=e.substring(6,8);t=new Date(Date.UTC(parseInt(o,10),parseInt(n,10)-1,parseInt(r,10)))}else if(e instanceof Date){t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))}if(t&&!isNaN(t.getTime())){return t}else{console.warn("Could not parse date:",e);return null}},onInvoiceClick:function(e){const t=e.getSource()?e.getSource().getText():null;if(!t){console.error("Could not get invoice number from event source.");sap.m.MessageToast.show("Cannot load invoice details.");return}const o=`/mock-api/invoices/${t}`;this._fetchInvoiceImage(o).then(e=>{if(e){this._showInvoiceDialog(e,t)}else{throw new Error("Invalid image URL received.")}}).catch(e=>{console.error("Error fetching/showing invoice:",e);sap.m.MessageToast.show(`Failed to load invoice ${t}.`)})},_fetchInvoiceImage:function(e){console.log("Fetching invoice image from:",e);return new Promise((e,t)=>{setTimeout(()=>{e("https://via.placeholder.com/600x800.png?text=Invoice+Image")},500)})},_showInvoiceDialog:function(e,t){if(this.oInvoiceDialog){this.oInvoiceDialog.destroy()}this.oInvoiceDialog=new r({title:`Invoice ${t||""}`,contentWidth:"auto",contentHeight:"70%",verticalScrolling:true,content:new a({src:e,width:"100%",densityAware:false,decorative:false,alt:`Image for Invoice ${t||""}`}),buttons:[new i({text:"Download",icon:"sap-icon://download",press:()=>this._downloadImage(e,`Invoice_${t||"Image"}.png`)}),new i({text:"Print",icon:"sap-icon://print",press:()=>this._printImage(e)}),new i({text:"Close",type:sap.m.ButtonType.Emphasized,press:()=>{this.oInvoiceDialog.close()}})],afterClose:()=>{if(this.oInvoiceDialog){this.oInvoiceDialog.destroy();this.oInvoiceDialog=null}}});this.oInvoiceDialog.open()},_downloadImage:function(e,t){const o=document.createElement("a");o.href=e;o.download=t||"invoice_image.png";document.body.appendChild(o);o.click();document.body.removeChild(o)},_printImage:function(e){try{const t=window.open("","_blank","height=600,width=800");if(!t){s.warning("Could not open print window. Please check your browser's pop-up settings.");return}t.document.write("<html><head><title>Print Invoice</title>");t.document.write("<style>@media print { body { margin: 0; } img { max-width: 100%; height: auto; display: block; } }</style>");t.document.write("</head><body>");t.document.write(`<img src='${e}' onload='window.print(); window.close();' onerror='window.close(); alert("Could not load image for printing.");' />`);t.document.write("</body></html>");t.document.close()}catch(e){console.error("Error opening print window:",e);s.error("Could not open print window. Please try again or check browser settings.")}}})});
//# sourceMappingURL=View1.controller.js.map